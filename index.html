<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anderson Book Fair Management System (CAD)</title>
    <style>
        :root {
            --primary-color: #007bff; /* Blue */
            --secondary-color: #6c757d; /* Gray */
            --success-color: #28a745; /* Green */
            --warning-color: #ffc107; /* Yellow */
            --danger-color: #dc3545; /* Red */
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #333;
            --border-radius: 8px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header & Navigation */
        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 { color: var(--primary-color); }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 10px 20px;
            border: none;
            background-color: #e0e0e0;
            cursor: pointer;
            border-radius: var(--border-radius);
            font-weight: bold;
            transition: 0.3s;
        }

        .nav-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        /* Sections */
        .section {
            display: none;
            background: var(--card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            animation: fadeIn 0.3s;
        }

        .section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }

        label { display: block; margin-bottom: 5px; font-weight: 600; }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            flex-wrap: wrap; /* Allows wrapping on smaller screens */
        }

        .input-group input, .input-group select {
            flex-grow: 1;
        }
        
        /* Specific Layout for Payment */
        .payment-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        
        .itemized-list {
            list-style: none;
            padding: 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            min-height: 150px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .itemized-list li {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .itemized-list li:last-child {
            border-bottom: none;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            transition: background 0.2s;
        }

        .btn:hover { opacity: 0.9; }

        .btn-primary { background-color: var(--primary-color); }
        .btn-success { background-color: var(--success-color); }
        .btn-warning { background-color: var(--warning-color); color: #333; }
        .btn-danger { background-color: var(--danger-color); padding: 5px 10px; font-size: 0.8em;}
        .btn-info { background-color: #17a2b8; }
        .btn-secondary { background-color: var(--secondary-color); }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }

        th { background-color: #f1f1f1; }
        
        /* Refund Modal Style */
        #returnModal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 2000;
            width: 90%;
            max-width: 500px;
        }

        #notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--success-color);
            color: white;
            padding: 15px 25px;
            border-radius: 4px;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>üìö Anderson Book Fair Management System (CAD)</h1>
        <div class="nav-tabs">
            <button class="nav-btn active" onclick="showSection('payment')">üí∞ New Transaction</button>
            <button class="nav-btn" onclick="showSection('records')">üìä Transaction Records</button>
            <button class="nav-btn" onclick="showSection('students')">üë®‚Äçüéì Student Management</button>
            <button class="nav-btn" onclick="showSection('fees')">üìù Item/Fee Setup</button>
        </div>
    </header>

    <div id="payment" class="section active">
        <h2>New Transaction</h2>
        
        <h3>1. Select Student</h3>
        <div class="input-group" style="margin-bottom: 20px;">
            <input type="text" id="payStudentSearch" placeholder="Search Last Name, First Name, or ID" oninput="renderPayStudentOptions()">
            <select id="payStudentField" onchange="renderPayStudentOptions()">
                <option value="all">All Fields</option>
                <option value="lastName">Last Name</option>
                <option value="firstName">First Name</option>
                <option value="studentId">Student ID</option>
            </select>
            <select id="payStudentSelect" style="flex-grow: 2;">
                <option value="">-- Select Student --</option>
            </select>
        </div>

        <div class="payment-grid">
            <div>
                <h3>2. Add Items/Fees</h3>
                <div class="input-group">
                    <select id="itemSelect" onchange="updateItemPrice()">
                        <option value="">-- Select Item/Fee --</option>
                    </select>
                    <input type="number" id="itemQuantity" value="1" min="1" style="width: 80px;">
                    <input type="number" id="itemPriceDisplay" placeholder="Price" readonly style="width: 100px;">
                    <button class="btn btn-primary" onclick="addItemToCart()">Add</button>
                </div>
                
                <ul id="itemizedList" class="itemized-list"></ul>
                
                <div class="form-group" style="margin-top: 20px;">
                    <button class="btn btn-warning" onclick="resetCart()">Reset All Items</button>
                </div>
            </div>
            
            <div style="background-color: #f1f1f1; padding: 15px; border-radius: 4px;">
                <h3>3. Confirm & Pay</h3>
                
                <div class="form-group">
                    <label>Total Amount Due (CAD):</label>
                    <input type="number" id="calculatedTotalDisplay" value="0.00" readonly style="font-size: 1.5em; text-align: right;">
                </div>
                
                <div class="form-group">
                    <label for="paymentMethod">Payment Method:</label>
                    <select id="paymentMethod">
                        <option value="Cash">Cash</option>
                        <option value="Card">Card</option>
                    </select>
                </div>
                
                <button class="btn btn-success" onclick="processPayment()" style="width: 100%; margin-top: 15px; font-size: 1.2em;">Complete Transaction</button>
            </div>
        </div>
    </div>

    <div id="records" class="section">
        <h2>Transaction Records</h2>
        <h3>Detailed Transaction Records</h3>
        <div class="action-bar">
            <button class="btn btn-warning" onclick="exportToExcel()">üì• Export CSV</button>
            <button class="btn btn-danger" onclick="clearAllData()">‚ö†Ô∏è Clear All Data</button>
        </div>
        
        <table>
            <thead>
                <tr>
                    <th>Date/Time</th>
                    <th>Student Name</th>
                    <th>Items Purchased</th>
                    <th>Payment Method</th>
                    <th>Original Amount</th>
                    <th>Returned Amount</th>
                    <th>Net Amount</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="recordsTableBody"></tbody>
        </table>
    </div>

    <div id="students" class="section">
        <h2>Student List Management</h2>
        
        <h3>Add New Student</h3>
        <div class="input-group" style="margin-bottom: 20px;">
            <input type="text" id="newStudentId" placeholder="Student ID (Manual)" required>
            <input type="text" id="newStudentLName" placeholder="Last Name" required>
            <input type="text" id="newStudentFName" placeholder="First Name" required>
            <input type="text" id="newStudentDivision" placeholder="Division (e.g. Grade 10)">
            <button class="btn btn-primary" onclick="addStudent()">Add Student</button>
        </div>
        
        <h3>Search Students</h3>
        <div class="input-group" style="margin-bottom: 20px;">
            <input type="text" id="studentSearchInput" placeholder="Search by Last Name, First Name, or ID">
            <select id="studentSearchField">
                <option value="all">All Fields</option>
                <option value="lastName">Last Name</option>
                <option value="firstName">First Name</option>
                <option value="studentId">Student ID</option>
                <option value="division">Division</option>
            </select>
            <button class="btn btn-info" onclick="renderStudents()">Search</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Student ID</th>
                    <th>Last Name</th>
                    <th>First Name</th>
                    <th>Division</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="studentTableBody"></tbody>
        </table>
    </div>

    <div id="fees" class="section">
        <h2>Book Fair Item/Fee Setup</h2>
        <div class="input-group" style="margin-bottom: 20px;">
            <input type="text" id="newItemName" placeholder="Item Name (e.g. Harry Potter 1)">
            <select id="newItemType">
                <option value="Book">Book</option>
                <option value="Stationery">Stationery</option>
                <option value="Misc">Miscellaneous</option>
            </select>
            <input type="number" id="newItemAmount" placeholder="Price (CAD)" min="0.01" step="0.01">
            <button class="btn btn-primary" onclick="addFeeType()">Add Item</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Item Name</th>
                    <th>Category</th>
                    <th>Price (CAD)</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="feeTableBody"></tbody>
        </table>
    </div>
</div>

<div id="returnModal" style="display:none;">
    <h3>Process Item Return</h3>
    <p>Transaction ID: <span id="returnTransactionId"></span></p>
    <p>Student: <span id="returnStudentDetails"></span></p>
    <p>Original Total: <span id="returnOriginalAmount"></span> | Returned So Far: <span id="returnedSoFar"></span></p>
    
    <label for="returnType">Return Type:</label>
    <select id="returnType" onchange="toggleReturnOptions()">
        <option value="full">Full Transaction Return</option>
        <option value="partial">Partial Item Return</option>
    </select>
    
    <div id="partialReturnContainer" style="margin-top: 15px; border: 1px solid #ddd; padding: 15px; display:none;">
        <h4>Items in Transaction:</h4>
        <ul id="itemsInTransaction" class="itemized-list"></ul>
        
        <div class="form-group" style="margin-top: 10px;">
            <label for="returnAmountManual">Manual Return Amount (CAD):</label>
            <input type="number" id="returnAmountManual" min="0.01" step="0.01" placeholder="Enter amount to return">
        </div>
    </div>
    
    <button class="btn btn-success" onclick="confirmReturn()" style="margin-top: 20px;">Confirm Return</button>
    <button class="btn btn-secondary" onclick="closeReturnModal()">Cancel</button>
</div>


<div id="notification">Operation Successful!</div>

<script>
    const DB_KEYS = {
        STUDENTS: 'bf_students_v4',
        FEES: 'bf_fees_v4',
        RECORDS: 'bf_records_v4'
    };
    const CURRENCY_CODE = 'CAD';

    let students = JSON.parse(localStorage.getItem(DB_KEYS.STUDENTS)) || [];
    let feeTypes = JSON.parse(localStorage.getItem(DB_KEYS.FEES)) || [];
    let records = JSON.parse(localStorage.getItem(DB_KEYS.RECORDS)) || [];
    let currentCart = [];
    let recordToReturn = null; 

    window.onload = function() {
        renderAll();
    };

    function saveData() {
        localStorage.setItem(DB_KEYS.STUDENTS, JSON.stringify(students));
        localStorage.setItem(DB_KEYS.FEES, JSON.stringify(feeTypes));
        localStorage.setItem(DB_KEYS.RECORDS, JSON.stringify(records));
        renderAll();
    }

    function renderAll() {
        renderStudents();
        renderFees();
        renderRecords();
        renderPayStudentOptions(); // Initial student list for payment
        renderItemOptions(); // Item list for payment
        updateDashboard();
        updateCartDisplay();
    }

    function showSection(sectionId) {
        document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        
        document.getElementById(sectionId).classList.add('active');
        
        const buttons = document.querySelectorAll('.nav-btn');
        const sections = ['payment', 'records', 'students', 'fees'];
        const index = sections.indexOf(sectionId);
        if(index !== -1) buttons[index].classList.add('active');
    }

    function showNotification(msg) {
        const notif = document.getElementById('notification');
        notif.textContent = msg;
        notif.style.display = 'block';
        setTimeout(() => { notif.style.display = 'none'; }, 3000);
    }
    
    // Utility for currency formatting
    function formatCurrency(amount) {
        return `${CURRENCY_CODE} ${Number(amount).toFixed(2)}`;
    }

    /* --- Student Management --- */
    function addStudent() {
        const idInput = document.getElementById('newStudentId');
        const lNameInput = document.getElementById('newStudentLName');
        const fNameInput = document.getElementById('newStudentFName');
        const divInput = document.getElementById('newStudentDivision');
        
        const studentId = idInput.value.trim();
        const lastName = lNameInput.value.trim();
        const firstName = fNameInput.value.trim();
        const division = divInput.value.trim();
        
        if (!studentId || !lastName || !firstName) return alert('Please enter Student ID, Last Name, and First Name.');
        if (students.some(s => s.studentId === studentId)) return alert('Student ID already exists.');

        students.push({ studentId, lastName, firstName, division });
        
        idInput.value = '';
        lNameInput.value = '';
        fNameInput.value = '';
        divInput.value = '';
        saveData();
        showNotification(`Student Added: ${firstName} ${lastName}`);
    }

    function deleteStudent(index) {
        if(confirm('Are you sure you want to delete this student?')) {
            students.splice(index, 1);
            saveData();
        }
    }

    function renderStudents() {
        const tbody = document.getElementById('studentTableBody');
        const searchInput = document.getElementById('studentSearchInput').value.toLowerCase();
        const searchField = document.getElementById('studentSearchField').value;
        
        let filteredStudents = students.filter(s => {
            if (!searchInput) return true;
            
            const searchTerms = {
                all: [s.lastName, s.firstName, s.division, s.studentId].map(t => t.toLowerCase()),
                lastName: s.lastName.toLowerCase(),
                firstName: s.firstName.toLowerCase(),
                division: s.division.toLowerCase(),
                studentId: s.studentId.toLowerCase()
            };
            
            if (searchField === 'all') {
                return searchTerms.all.some(term => term.includes(searchInput));
            } else {
                return searchTerms[searchField].includes(searchInput);
            }
        });

        if (filteredStudents.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#888;">No students found.</td></tr>';
            return;
        }

        tbody.innerHTML = filteredStudents.map((s, index) => `
            <tr>
                <td>${s.studentId}</td>
                <td>${s.lastName}</td>
                <td>${s.firstName}</td>
                <td>${s.division}</td>
                <td><button class="btn btn-danger" onclick="deleteStudent(${index})">Delete</button></td>
            </tr>
        `).join('');
    }
    
    /* --- Fee/Item Setup --- */
    function addFeeType() {
        const nameInput = document.getElementById('newItemName');
        const amountInput = document.getElementById('newItemAmount');
        const typeSelect = document.getElementById('newItemType');
        
        const name = nameInput.value.trim();
        const amount = Number(amountInput.value);
        const type = typeSelect.value;

        if (!name || amount <= 0 || isNaN(amount)) return alert('Please enter a valid Item Name and Price.');
        if (feeTypes.some(f => f.name.toLowerCase() === name.toLowerCase())) return alert('Item name already exists.');

        feeTypes.push({ id: Date.now(), name, amount: amount.toFixed(2), type });
        nameInput.value = '';
        amountInput.value = '';
        saveData();
        showNotification(`Item Added: ${name}`);
    }

    function deleteFee(index) {
        if(confirm('Are you sure you want to delete this item?')) {
            feeTypes.splice(index, 1);
            saveData();
        }
    }

    function renderFees() {
        const tbody = document.getElementById('feeTableBody');
        tbody.innerHTML = feeTypes.map((f, index) => `
            <tr>
                <td>${f.name}</td>
                <td>${f.type}</td>
                <td>${formatCurrency(f.amount)}</td>
                <td><button class="btn btn-danger" onclick="deleteFee(${index})">Delete</button></td>
            </tr>
        `).join('');
    }
    
    function renderItemOptions() {
        const select = document.getElementById('itemSelect');
        select.innerHTML = '<option value="">-- Select Item/Fee --</option>' + 
            feeTypes.map(f => `<option value="${f.id}">${f.name} (${formatCurrency(f.amount)})</option>`).join('');
        updateItemPrice(); // Update price display after rendering options
    }
    
    function updateItemPrice() {
        const select = document.getElementById('itemSelect');
        const priceDisplay = document.getElementById('itemPriceDisplay');
        const selectedItem = feeTypes.find(f => f.id == select.value);
        
        priceDisplay.value = selectedItem ? selectedItem.amount : '0.00';
    }


    /* --- Payment Counter Logic --- */
    function renderPayStudentOptions() {
        const sSelect = document.getElementById('payStudentSelect');
        const searchInput = document.getElementById('payStudentSearch').value.toLowerCase();
        const searchField = document.getElementById('payStudentField').value;

        let filteredStudents = students.filter(s => {
            if (!searchInput) return true;
            
            const searchTerms = {
                all: [s.lastName, s.firstName, s.studentId].map(t => t.toLowerCase()),
                lastName: s.lastName.toLowerCase(),
                firstName: s.firstName.toLowerCase(),
                studentId: s.studentId.toLowerCase()
            };
            
            if (searchField === 'all') {
                return searchTerms.all.some(term => term.includes(searchInput));
            } else {
                return searchTerms[searchField].includes(searchInput);
            }
        });
        
        sSelect.innerHTML = '<option value="">-- Select Student --</option>' + 
            filteredStudents.map(s => `<option value="${s.studentId}|${s.firstName} ${s.lastName}|${s.division}">${s.lastName}, ${s.firstName} (${s.studentId}) - ${s.division}</option>`).join('');
    }

    function addItemToCart() {
        const itemSelect = document.getElementById('itemSelect');
        const quantityInput = document.getElementById('itemQuantity');
        
        const itemId = itemSelect.value;
        const quantity = Number(quantityInput.value);
        
        if (!itemId || quantity <= 0 || isNaN(quantity)) return alert('Please select an item and a valid quantity.');
        
        const selectedItem = feeTypes.find(f => f.id == itemId);
        const itemTotal = (Number(selectedItem.amount) * quantity).toFixed(2);
        
        currentCart.push({
            id: selectedItem.id,
            name: selectedItem.name,
            price: Number(selectedItem.amount).toFixed(2),
            quantity: quantity,
            total: itemTotal
        });
        
        itemSelect.value = ""; // Clear selection
        quantityInput.value = "1";
        
        updateCartDisplay();
    }
    
    function removeItemFromCart(index) {
        currentCart.splice(index, 1);
        updateCartDisplay();
    }
    
    function resetCart() {
        currentCart = [];
        updateCartDisplay();
    }

    function updateCartDisplay() {
        const list = document.getElementById('itemizedList');
        const total = currentCart.reduce((sum, item) => sum + Number(item.total), 0);
        const calculatedTotalDisplay = document.getElementById('calculatedTotalDisplay');
        
        calculatedTotalDisplay.value = total.toFixed(2);

        list.innerHTML = currentCart.map((item, index) => `
            <li>
                <span>${item.name} (${formatCurrency(item.price)} x ${item.quantity})</span>
                <span>${formatCurrency(item.total)} <button class="btn btn-danger" onclick="removeItemFromCart(${index})">X</button></span>
            </li>
        `).join('');
    }

    function processPayment() {
        const sSelect = document.getElementById('payStudentSelect');
        const paymentMethod = document.getElementById('paymentMethod').value;
        const finalAmount = Number(document.getElementById('calculatedTotalDisplay').value);

        if (!sSelect.value) return alert('Please select a student.');
        if (currentCart.length === 0) return alert('Please add at least one item to the cart.');
        if (finalAmount <= 0) return alert('Transaction amount must be greater than zero.');

        const studentData = sSelect.value.split('|');
        const studentId = studentData[0];
        const studentName = studentData[1];
        
        const record = {
            id: Date.now(),
            date: new Date().toLocaleString(),
            studentId,
            studentName,
            paymentMethod,
            originalAmount: finalAmount,
            returnedAmount: 0,
            netAmount: finalAmount,
            items: currentCart // Store the items sold
        };

        records.unshift(record);
        saveData();
        showNotification(`Transaction Successful! ${paymentMethod} payment of ${formatCurrency(finalAmount)}.`);
        sSelect.value = "";
        resetCart(); // Reset the cart after successful payment
        renderPayStudentOptions();
    }

    /* --- Records & Returns --- */
    function renderRecords() {
        const tbody = document.getElementById('recordsTableBody');

        if (records.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#888;">No transaction records yet.</td></tr>';
            return;
        }

        tbody.innerHTML = records.map((r, index) => {
            const isFullyReturned = r.netAmount <= 0;
            const returnBtn = isFullyReturned 
                ? `<button class="btn btn-secondary" disabled>Fully Returned</button>`
                : `<button class="btn btn-info" onclick="openReturnModal(${r.id})">Return Transaction</button>`;
            
            const itemsSummary = r.items.map(i => `${i.name} (${i.quantity})`).join(', ');

            return `
                <tr>
                    <td>${r.date}</td>
                    <td>${r.studentName}</td>
                    <td title="${itemsSummary}">${r.items.length} items</td>
                    <td>${r.paymentMethod}</td>
                    <td>${formatCurrency(r.originalAmount)}</td>
                    <td style="color: ${r.returnedAmount > 0 ? 'red' : '#888'};">${formatCurrency(r.returnedAmount)}</td>
                    <td style="color: ${isFullyReturned ? '#888' : 'var(--success-color)'}; font-weight:bold;">${formatCurrency(r.netAmount)}</td>
                    <td>
                        ${returnBtn}
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    function openReturnModal(recordId) {
        recordToReturn = records.find(r => r.id === recordId);
        if (!recordToReturn || recordToReturn.netAmount <= 0) {
            return alert("This transaction is not eligible for return or is fully returned.");
        }
        
        document.getElementById('returnTransactionId').textContent = recordToReturn.id;
        document.getElementById('returnStudentDetails').textContent = recordToReturn.studentName;
        document.getElementById('returnOriginalAmount').textContent = formatCurrency(recordToReturn.originalAmount);
        document.getElementById('returnedSoFar').textContent = formatCurrency(recordToReturn.returnedAmount);
        
        document.getElementById('returnType').value = 'full';
        toggleReturnOptions(); // Set initial state
        
        document.getElementById('returnModal').style.display = 'block';
    }
    
    function closeReturnModal() {
        document.getElementById('returnModal').style.display = 'none';
        recordToReturn = null;
    }
    
    function toggleReturnOptions() {
        const type = document.getElementById('returnType').value;
        const partialContainer = document.getElementById('partialReturnContainer');
        const amountManual = document.getElementById('returnAmountManual');
        const itemsList = document.getElementById('itemsInTransaction');
        
        if (type === 'partial') {
            partialContainer.style.display = 'block';
            amountManual.value = '0.00';
            
            // Populate items list for tracking (though return is manual amount)
            itemsList.innerHTML = recordToReturn.items.map(item => `
                <li>
                    <span>${item.name} x ${item.quantity}</span>
                    <span>${formatCurrency(item.total)}</span>
                </li>
            `).join('');

        } else {
            // Full return
            partialContainer.style.display = 'none';
        }
    }

    function confirmReturn() {
        const type = document.getElementById('returnType').value;
        let amountToReturn = 0;
        
        if (type === 'full') {
            amountToReturn = recordToReturn.netAmount;
        } else {
            amountToReturn = Number(document.getElementById('returnAmountManual').value);
        }

        if (amountToReturn <= 0 || isNaN(amountToReturn)) {
            return alert('Please enter a valid return amount.');
        }
        
        if (amountToReturn > recordToReturn.netAmount) {
            return alert(`Return amount cannot exceed net payable amount (${formatCurrency(recordToReturn.netAmount)}).`);
        }
        
        // Process the return
        recordToReturn.returnedAmount += amountToReturn;
        recordToReturn.netAmount -= amountToReturn;
        
        // Ensure netAmount is not negative due to floating point arithmetic
        recordToReturn.netAmount = Math.max(0, recordToReturn.netAmount); 
        
        saveData();
        closeReturnModal();
        showNotification(`Return of ${formatCurrency(amountToReturn)} processed for ${recordToReturn.studentName}.`);
    }

    // (Update Dashboard and Clear All Data functions remain similar)
    function updateDashboard() {
        const netTotal = records.reduce((sum, r) => sum + r.netAmount, 0);
        document.getElementById('totalIncome').textContent = formatCurrency(netTotal);
        // Simplified dashboard update, assuming you will add stat cards back if needed.
    }

    function clearAllData() {
        if(confirm('This will delete ALL student, item, and transaction data! Are you sure?')) {
            if(confirm('FINAL CONFIRMATION: Data will be permanently lost!')) {
                localStorage.clear();
                students = [];
                feeTypes = [];
                records = [];
                renderAll();
                showNotification('System reset successful.');
            }
        }
    }

    function exportToExcel() {
        if (records.length === 0) {
            return alert("No data to export!");
        }

        let csvContent = "\uFEFF"; 
        csvContent += "Date/Time,Student ID,Student Name,Payment Method,Items Purchased,Original Amount (CAD),Returned Amount (CAD),Net Amount (CAD)\n";

        records.forEach(row => {
            const itemsDetail = row.items.map(i => `${i.name} (Qty: ${i.quantity}, Price: ${i.price})`).join('; ');
            csvContent += `"${row.date}","${row.studentId}","${row.studentName}","${row.paymentMethod}","${itemsDetail.replace(/"/g, '""')}",${row.originalAmount.toFixed(2)},${row.returnedAmount.toFixed(2)},${row.netAmount.toFixed(2)}\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");

        const date = new Date();
        const filename = `BookFair_Report_${date.getFullYear()}${String(date.getMonth()+1).padStart(2,'0')}${date.getDate()}.csv`;

        link.href = url;
        link.download = filename;
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showNotification("Report Downloaded!");
    }
    
</script>

</body>
</html>