<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Fee Collection System v2.0</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4361ee">

    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --success-color: #4cc9f0;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #333;
            --border-radius: 8px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        /* Header & Navigation */
        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 { color: var(--primary-color); }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap; 
        }

        .nav-btn {
            padding: 12px 25px; /* Touched up for touchscreens */
            border: none;
            background-color: #e0e0e0;
            cursor: pointer;
            border-radius: var(--border-radius);
            font-weight: bold;
            transition: 0.3s;
        }

        .nav-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        /* Sections */
        .section {
            display: none;
            background: var(--card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            animation: fadeIn 0.3s;
        }

        .section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Forms: Touchscreen Optimized */
        .form-group {
            margin-bottom: 15px;
        }

        label { display: block; margin-bottom: 5px; font-weight: 600; }
        
        input, select {
            width: 100%;
            padding: 12px; /* Touched up for touchscreens */
            height: 48px; /* Fixed height for consistent tapping on iPad */
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1.1em; /* Increased font size for legibility */
        }

        .btn {
            padding: 12px 24px; /* Touched up for touchscreens */
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            transition: background 0.2s;
            min-height: 48px; /* Minimum tap target height */
        }

        .btn:hover { opacity: 0.9; }

        .btn-primary { background-color: var(--primary-color); }
        .btn-success { background-color: #2a9d8f; }
        .btn-warning { background-color: #fca311; color: #333; } /* Export Button */
        
        /* Danger buttons (smaller in tables) - still optimized for touch */
        .btn-danger { 
            background-color: #e63946; 
            padding: 8px 15px; 
            font-size: 0.9em;
            min-height: 38px;
        }

        /* Tables: Touchscreen Optimized */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            text-align: left;
            padding: 15px 12px; /* Increased vertical padding for rows */
            border-bottom: 1px solid #ddd;
            font-size: 1em;
        }

        th { background-color: #f1f1f1; }

        /* Dashboard Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--primary-color);
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
        }
        
        .stat-card h3 { margin: 0; font-size: 2em; }
        .stat-card p { margin: 5px 0 0 0; opacity: 0.9; }

        /* Action Bar in Records */
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        /* Notification */
        #notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #2a9d8f;
            color: white;
            padding: 15px 25px;
            border-radius: 4px;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>üéì School Fee Collection System</h1>
        <div class="nav-tabs">
            <button class="nav-btn active" onclick="showSection('payment')">üí∞ Payment Counter</button>
            <button class="nav-btn" onclick="showSection('records')">üìä Financial Report</button>
            <button class="nav-btn" onclick="showSection('students')">üë®‚Äçüéì Student Management</button>
            <button class="nav-btn" onclick="showSection('fees')">üìù Fee Configuration</button>
        </div>
    </header>

    <div id="payment" class="section active">
        <h2>Add Payment Record</h2>
        <div class="dashboard-grid">
            <div class="form-group">
                <label>Select Student:</label>
                <select id="payStudentSelect"></select>
            </div>
            <div class="form-group">
                <label>Select Fee Item:</label>
                <select id="payFeeSelect"></select>
            </div>
        </div>
        <div class="form-group">
            <label>Amount Confirmation (TWD):</label>
            <input type="number" id="payAmountDisplay" readonly>
        </div>
        <button class="btn btn-success" onclick="processPayment()" style="width: 100%; font-size: 1.2em;">Confirm Payment</button>
    </div>

    <div id="records" class="section">
        <h2>Financial Overview</h2>
        <div class="dashboard-grid">
            <div class="stat-card">
                <h3 id="totalIncome">NT$0</h3>
                <p>Total Income</p>
            </div>
            <div class="stat-card" style="background-color: #2a9d8f;">
                <h3 id="totalTransactions">0</h3>
                <p>Total Transactions</p>
            </div>
        </div>
        
        <h3>Detailed Transaction Records</h3>
        <div class="action-bar">
            <button class="btn btn-warning" onclick="exportRecordsToCSV()">üì• Export Transaction CSV</button>
            <button class="btn btn-danger" onclick="clearAllData()">‚ö†Ô∏è Clear All Data</button>
        </div>
        
        <table>
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Student Name</th>
                    <th>Fee Item</th>
                    <th>Amount</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="recordsTableBody">
                </tbody>
        </table>
    </div>

    <div id="students" class="section">
        <h2>Student List Management</h2>

        <div class="action-bar" style="justify-content: flex-start; gap: 10px;">
            <button class="btn btn-warning" onclick="exportStudentsToCSV()">üì• Export Student List</button>
            <input type="file" id="importStudentsFile" accept=".csv" style="display:none;" onchange="importStudentsFromCSV(event)">
            <button class="btn btn-primary" onclick="document.getElementById('importStudentsFile').click()">üì§ Import Student List</button>
        </div>
        
        <h3>Add New Student</h3>
        <div class="form-group" style="display: flex; gap: 10px;">
            <input type="text" id="newStudentName" placeholder="Enter student name (e.g., John Doe)">
            <input type="text" id="newStudentId" placeholder="Student ID (Optional)">
            <button class="btn btn-success" onclick="addStudent()">Add Student</button>
        </div>
        
        <h3>Current Student List</h3>
        <table>
            <thead>
                <tr>
                    <th>Student ID</th>
                    <th>Name</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="studentTableBody">
                </tbody>
        </table>
    </div>

    <div id="fees" class="section">
        <h2>Fee Item Configuration</h2>
        <div class="form-group" style="display: flex; gap: 10px;">
            <input type="text" id="newFeeName" placeholder="Fee name (e.g., Semester Book Fee)">
            <input type="number" id="newFeeAmount" placeholder="Amount">
            <button class="btn btn-primary" onclick="addFeeType()">Add Fee</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Fee Name</th>
                    <th>Default Amount</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="feeTableBody">
                </tbody>
        </table>
    </div>
</div>

<div id="notification">Operation Successful!</div>

<script>
    // --- Data Storage (Using LocalStorage) ---
    const DB_KEYS = {
        STUDENTS: 'school_students',
        FEES: 'school_fees',
        RECORDS: 'school_records'
    };

    let students = JSON.parse(localStorage.getItem(DB_KEYS.STUDENTS)) || [];
    let feeTypes = JSON.parse(localStorage.getItem(DB_KEYS.FEES)) || [];
    let records = JSON.parse(localStorage.getItem(DB_KEYS.RECORDS)) || [];

    // --- Security Setting: Administrator Password ---
    const ADMIN_PASSWORD = '123'; // ***PLEASE CHANGE THIS PASSWORD!***

    function saveData() {
        localStorage.setItem(DB_KEYS.STUDENTS, JSON.stringify(students));
        localStorage.setItem(DB_KEYS.FEES, JSON.stringify(feeTypes));
        localStorage.setItem(DB_KEYS.RECORDS, JSON.stringify(records));
        renderAll();
    }

    function renderAll() {
        renderStudents();
        renderFees();
        renderRecords();
        renderPaymentOptions();
        updateDashboard();
    }

    // --- UI Navigation & Password Check ---
    function checkAdminAccess() {
        if (sessionStorage.getItem('adminLoggedIn') === 'true') {
            return true;
        }
        const password = prompt('Please enter the administrator password:');
        if (password === ADMIN_PASSWORD) {
            sessionStorage.setItem('adminLoggedIn', 'true');
            showNotification('Admin Login Successful!');
            return true;
        } else {
            alert('Incorrect password! You will not be able to access the admin interface.');
            sessionStorage.setItem('adminLoggedIn', 'false');
            return false;
        }
    }

    function showSection(sectionId) {
        document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));

        const isAdminSection = ['records', 'students', 'fees'].includes(sectionId);

        if (isAdminSection) {
            if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
                if (!checkAdminAccess()) {
                    sectionId = 'payment'; 
                }
            }
        }
        
        document.getElementById(sectionId).classList.add('active');
        
        const buttons = document.querySelectorAll('.nav-btn');
        if(sectionId === 'payment') buttons[0].classList.add('active');
        if(sectionId === 'records') buttons[1].classList.add('active');
        if(sectionId === 'students') buttons[2].classList.add('active');
        if(sectionId === 'fees') buttons[3].classList.add('active');
    }

    function showNotification(msg) {
        const notif = document.getElementById('notification');
        notif.textContent = msg;
        notif.style.display = 'block';
        setTimeout(() => { notif.style.display = 'none'; }, 3000);
    }

    // --- Initialization ---
    window.onload = function() {
        renderAll();
        document.getElementById('payFeeSelect').addEventListener('change', updatePayAmount);
        showSection('payment');

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // IMPORTANT: Ensure sw.js and manifest.json are in the root directory
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker registered: ', reg.scope))
                    .catch(err => console.log('Service Worker registration failed: ', err));
            });
        }
    };

    // --- Student Logic ---
    function addStudent() {
        const nameInput = document.getElementById('newStudentName');
        const idInput = document.getElementById('newStudentId');
        const name = nameInput.value.trim();
        const id = idInput.value.trim() || 'S' + (students.length + 1).toString().padStart(3, '0');

        if (!name) return alert('Please enter student name');

        students.push({ id, name });
        nameInput.value = '';
        idInput.value = '';
        saveData();
        showNotification(`Added student: ${name}`);
    }

    function deleteStudent(index) {
        if(confirm('Are you sure you want to delete this student?')) {
            students.splice(index, 1);
            saveData();
        }
    }

    function renderStudents() {
        const tbody = document.getElementById('studentTableBody');
        tbody.innerHTML = students.map((s, index) => `
            <tr>
                <td>${s.id}</td>
                <td>${s.name}</td>
                <td><button class="btn btn-danger" onclick="deleteStudent(${index})">Delete</button></td>
            </tr>
        `).join('');
    }
    
    // --- Student Import/Export Functions ---
    function exportStudentsToCSV() {
        if (students.length === 0) {
            return alert("No student data to export!");
        }

        let csvContent = "\uFEFF"; // Add BOM
        csvContent += "Student ID,Student Name\n";

        students.forEach(function(s) {
            let rowString = `"${s.id}","${s.name}"`;
            csvContent += rowString + "\n";
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        
        const date = new Date().toISOString().slice(0, 10);
        const fileName = `StudentList_Export_${date}.csv`;
        
        link.setAttribute("href", url);
        link.setAttribute("download", fileName);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification("Student list downloaded!");
    }

    function importStudentsFromCSV(event) {
        const file = event.target.files[0];
        if (!file) return;

        if(!confirm("Are you sure you want to import this list? This will REPLACE all current student data.")) {
            event.target.value = null; 
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim() !== '');
                
                if (lines.length <= 1) { 
                    return alert("CSV file is empty or contains no data rows.");
                }
                
                const newStudents = [];
                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(',').map(col => col.trim().replace(/^"|"$/g, ''));
                    if (cols.length >= 2) {
                        const id = cols[0] || 'S' + (newStudents.length + 1).toString().padStart(3, '0');
                        const name = cols[1];
                        if (name) {
                            newStudents.push({ id, name });
                        }
                    }
                }

                if (newStudents.length > 0) {
                    students = newStudents;
                    saveData();
                    showNotification(`Successfully imported ${newStudents.length} students!`);
                } else {
                    alert("No valid student data found in the CSV file.");
                }
            } catch (error) {
                alert("Error reading or parsing CSV file: " + error.message);
            }
            event.target.value = null;
        };
        reader.onerror = () => {
             alert("Could not read the file.");
             event.target.value = null;
        }
        reader.readAsText(file, 'UTF-8');
    }

    // --- Fee Logic ---
    function addFeeType() {
        const nameInput = document.getElementById('newFeeName');
        const amountInput = document.getElementById('newFeeAmount');
        const name = nameInput.value.trim();
        const amount = Number(amountInput.value);

        if (!name || amount <= 0) return alert('Please enter a valid fee name and amount');

        feeTypes.push({ id: Date.now(), name, amount });
        nameInput.value = '';
        amountInput.value = '';
        saveData();
        showNotification(`Added fee item: ${name}`);
    }

    function deleteFee(index) {
        if(confirm('Are you sure you want to delete this fee item?')) {
            feeTypes.splice(index, 1);
            saveData();
        }
    }

    function renderFees() {
        const tbody = document.getElementById('feeTableBody');
        tbody.innerHTML = feeTypes.map((f, index) => `
            <tr>
                <td>${f.name}</td>
                <td>NT$${f.amount}</td>
                <td><button class="btn btn-danger" onclick="deleteFee(${index})">Delete</button></td>
            </tr>
        `).join('');
    }

    // --- Payment Logic ---
    function renderPaymentOptions() {
        const sSelect = document.getElementById('payStudentSelect');
        const fSelect = document.getElementById('payFeeSelect');
        const currentStudent = sSelect.value;
        const currentFee = fSelect.value;

        sSelect.innerHTML = '<option value="">-- Select Student --</option>' + 
            students.map(s => `<option value="${s.name}">${s.id} - ${s.name}</option>`).join('');
            
        fSelect.innerHTML = '<option value="">-- Select Fee --</option>' + 
            feeTypes.map((f, index) => `<option value="${index}">${f.name} (NT$${f.amount})</option>`).join('');

        if(currentStudent) sSelect.value = currentStudent;
        updatePayAmount();
    }

    function updatePayAmount() {
        const fSelect = document.getElementById('payFeeSelect');
        const amountDisplay = document.getElementById('payAmountDisplay');
        
        if (fSelect.value !== "") {
            const feeIndex = fSelect.value;
            amountDisplay.value = feeTypes[feeIndex].amount;
        } else {
            amountDisplay.value = '';
        }
    }

    function processPayment() {
        const sSelect = document.getElementById('payStudentSelect');
        const fSelect = document.getElementById('payFeeSelect');
        const amountDisplay = document.getElementById('payAmountDisplay');

        if (!sSelect.value || fSelect.value === "") {
            return alert('Please select a student and a fee item');
        }

        const studentName = sSelect.value;
        const feeIndex = fSelect.value;
        const feeData = feeTypes[feeIndex];
        const actualAmount = Number(amountDisplay.value);

        const record = {
            id: Date.now(),
            date: new Date().toLocaleString(),
            studentName: studentName,
            feeName: feeData.name,
            amount: actualAmount
        };

        records.unshift(record);
        saveData();
        showNotification('Payment Successful!');
        sSelect.value = "";
    }

    // --- Records & Dashboard Logic ---
    function renderRecords() {
        const tbody = document.getElementById('recordsTableBody');
        if (records.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#888;">No payment records yet</td></tr>';
            return;
        }

        tbody.innerHTML = records.map((r, index) => `
            <tr>
                <td>${r.date}</td>
                <td>${r.studentName}</td>
                <td>${r.feeName}</td>
                <td style="color: var(--success-color); font-weight:bold;">NT$${r.amount}</td>
                <td><button class="btn btn-danger" onclick="deleteRecord(${index})">Revoke</button></td>
            </tr>
        `).join('');
    }

    function deleteRecord(index) {
        if(confirm('Are you sure you want to revoke this payment record? This action cannot be undone.')) {
            records.splice(index, 1);
            saveData();
        }
    }

    function updateDashboard() {
        const total = records.reduce((sum, r) => sum + r.amount, 0);
        document.getElementById('totalIncome').textContent = `NT$${total.toLocaleString()}`;
        document.getElementById('totalTransactions').textContent = records.length;
    }

    function clearAllData() {
        if(confirm('DANGER OPERATION: This will delete ALL students, fee configurations, and payment records! Are you sure?')) {
            if(confirm('FINAL CONFIRMATION: Data will be permanently lost!')) {
                localStorage.clear();
                students = [];
                feeTypes = [];
                records = [];
                renderAll();
                showNotification('System Reset Complete');
            }
        }
    }

    // --- EXCEL EXPORT FUNCTION (for Transactions) ---
    function exportRecordsToCSV() {
        if (records.length === 0) {
            return alert("No data to export!");
        }

        let csvContent = "\uFEFF"; 
        csvContent += "Time,Student Name,Fee Item,Amount\n";

        records.forEach(function(row) {
            let rowString = `"${row.date}","${row.studentName}","${row.feeName}",${row.amount}`;
            csvContent += rowString + "\n";
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        
        const date = new Date();
        const fileName = `FinancialReport_${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate()}.csv`;
        
        link.setAttribute("href", url);
        link.setAttribute("download", fileName);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification("Report downloaded!");
    }
</script>

</body>
</html>